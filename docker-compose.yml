version: '3.8'

services:
  ffmpeg:
    build:
      context: ./ffmpeg
      dockerfile: Dockerfile
    container_name: ffmpeg-source
    environment:
      - OUTPUT_HOST=gstreamer
      - OUTPUT_PORT=5000
      - VIDEO_WIDTH=${VIDEO_WIDTH:-1280}
      - VIDEO_HEIGHT=${VIDEO_HEIGHT:-720}
      - FRAMERATE=${FRAMERATE:-25}
      - BITRATE=${BITRATE:-2000k}
    networks:
      - srt-network
    depends_on:
      - gstreamer
    restart: unless-stopped

  gstreamer:
    build:
      context: ./gstreamer
      dockerfile: Dockerfile
    container_name: gstreamer-relay
    environment:
      - INPUT_PORT=5000
      - SRT_URL=${SRT_URL:-srt://host.docker.internal:9000}
      - USE_SRT_PARAMS=${USE_SRT_PARAMS:-true}
      - SRT_MODE=${SRT_MODE}
      - SRT_LATENCY=${SRT_LATENCY}
      - SRT_STREAMID=${SRT_STREAMID}
      - ENABLE_ENCRYPTION=${ENABLE_ENCRYPTION:-false}
      - SRT_PASSPHRASE=${SRT_PASSPHRASE}
      - SRT_PBKEYLEN=${SRT_PBKEYLEN}
    ports:
      - "5000:5000/udp"
    networks:
      - srt-network
    restart: unless-stopped

networks:
  srt-network:
    driver: bridge
